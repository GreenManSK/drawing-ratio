<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Drawing Proportion Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container .main-content {
            margin-bottom: 0;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 0.95em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            position: fixed;
            bottom: 0;
            left: 15px;
            right: 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 999;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
        }

        .stats.show {
            transform: translateY(0);
        }

        .stats-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            margin-top: 15px;
            width: 100%;
        }

        .stats-toggle:hover {
            background: #764ba2;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.75em;
            color: #666;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .section {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #667eea;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 12px;
            text-align: center;
            font-size: 1.3em;
        }

        .section-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* Reference Section */
        .controls {
            margin-bottom: 10px;
        }

        .control-group {
            margin-bottom: 8px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        select,
        input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #667eea;
            font-size: 0.9em;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .input-row input {
            padding: 6px;
        }

        button {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #764ba2;
        }

        .btn-secondary {
            background: #4caf50;
            color: white;
        }

        .btn-secondary:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            max-height: 100%;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: white;
            margin: 0 auto 10px auto;
            object-fit: contain;
        }

        .canvas-wrapper {
            flex: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ratio-info {
            padding: 10px;
            background: #fff9e6;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #ffc107;
            display: none;
        }

        .ratio-info.show {
            display: block;
        }

        .ratio-info h3 {
            color: #f57c00;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .ratio-display {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .ratio-description {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }

        /* Input Section */
        .measurement-inputs {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .compact-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .compact-input-row label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
            display: block;
        }

        .compact-input-row input {
            width: 100%;
        }

        /* Feedback Section */
        .feedback-content {
            display: none;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .feedback-content.show {
            display: flex;
        }

        .feedback-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #999;
            text-align: center;
            font-size: 1.1em;
            padding: 20px;
        }

        .section-content:has(.feedback-content.show) .feedback-placeholder {
            display: none;
        }

        .result-title {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 1.2em;
            text-align: center;
        }

        .accuracy-bar {
            height: 35px;
            background: #ddd;
            border-radius: 18px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .feedback-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .feedback-card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #4caf50;
        }

        .feedback-card label {
            display: block;
            font-size: 0.75em;
            color: #666;
            margin-bottom: 5px;
        }

        .feedback-card .value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .tips {
            background: #fff3e0;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
        }

        .tips h4 {
            color: #e65100;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        /* History Toggle */
        .history-toggle {
            margin-top: 10px;
            text-align: center;
        }

        .history-toggle button {
            background: #667eea;
            color: white;
            padding: 8px 20px;
            width: auto;
            font-size: 0.9em;
        }

        .history-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 3px solid #667eea;
            padding: 15px;
            max-height: 40vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
        }

        .history-panel.show {
            transform: translateY(0);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-header h3 {
            color: #667eea;
            font-size: 1.2em;
        }

        .close-history {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .history-list {
            display: grid;
            gap: 8px;
        }

        .history-item {
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .history-item .score {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .combined-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-section {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #667eea;
        }

        .input-section h2 {
            color: #667eea;
            margin-bottom: 12px;
            text-align: center;
            font-size: 1.3em;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main-content">
            <!-- Reference Section -->
            <div class="section">
                <h2>üéØ Reference</h2>
                <div class="section-content">
                    <div class="controls">
                        <div class="control-group">
                            <label for="shapeType">Shape:</label>
                            <select id="shapeType">
                                <option value="random">Random</option>
                                <option value="rectangle">Rectangle</option>
                                <option value="ellipse">Ellipse</option>
                                <option value="triangle">Triangle</option>
                                <option value="complex">Complex Shape</option>
                                <option value="complex-rounded">Complex Shape (Rounded)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="difficulty">Difficulty:</label>
                            <select id="difficulty">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>

                        <div class="control-group" id="customRatioInputs" style="display: none;">
                            <label>W : H Ratio:</label>
                            <div class="input-row">
                                <input type="number" id="customWidth" placeholder="W" min="1" step="0.1">
                                <input type="number" id="customHeight" placeholder="H" min="1" step="0.1">
                            </div>
                        </div>

                        <button class="btn-primary" id="generateBtn">Generate New</button>
                    </div>

                    <div class="canvas-wrapper">
                        <canvas id="referenceCanvas" width="800" height="800"></canvas>
                    </div>

                    <button class="btn-primary" id="showHintBtn" style="display: none;">üí° Show Hint (Target
                        Ratio)</button>

                    <div class="ratio-info" id="ratioInfo">
                        <h3>Target Ratio:</h3>
                        <div class="ratio-display" id="ratioDisplay">Click Generate</div>
                        <div class="ratio-description" id="ratioDescription"></div>
                    </div>
                </div>
            </div>

            <!-- Combined Input & Results Section -->
            <div class="combined-section">
                <!-- Input Section -->
                <div class="input-section">
                    <h2>‚úèÔ∏è Your Drawing</h2>
                    <div class="measurement-inputs">
                        <div class="compact-input-row">
                            <div>
                                <label>Width (mm):</label>
                                <input type="number" id="userWidth" placeholder="e.g., 85" step="0.1" min="0.1">
                            </div>
                            <div>
                                <label>Height (mm):</label>
                                <input type="number" id="userHeight" placeholder="e.g., 110" step="0.1" min="0.1">
                            </div>
                        </div>
                        <button class="btn-secondary" id="checkBtn" disabled>Check Accuracy</button>
                        <button class="btn-primary" id="generateBtn2">Generate New</button>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="section">
                    <h2>üìä Results</h2>
                    <div class="section-content">
                        <div class="feedback-placeholder">
                            Draw something and check accuracy to see results here!
                        </div>

                        <div class="feedback-content" id="feedbackContent">
                            <h3 class="result-title" id="resultTitle">Results</h3>
                            <div class="accuracy-bar">
                                <div class="accuracy-fill" id="accuracyFill">0%</div>
                            </div>
                            <div class="feedback-grid">
                                <div class="feedback-card">
                                    <label>Your Ratio</label>
                                    <div class="value" id="yourRatio">-</div>
                                </div>
                                <div class="feedback-card">
                                    <label>Target Ratio</label>
                                    <div class="value" id="targetRatio">-</div>
                                </div>
                                <div class="feedback-card">
                                    <label>Your Size</label>
                                    <div class="value" id="yourSize">-</div>
                                </div>
                                <div class="feedback-card">
                                    <label>Difference</label>
                                    <div class="value" id="difference">-</div>
                                </div>
                            </div>
                            <div class="tips" id="tips">
                                <h4>üí° Tip</h4>
                                <p id="tipText">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Toggle Button -->
        <button class="stats-toggle" id="statsToggle">üìä Stats</button>
    </div>

    <!-- Stats Bar -->
    <div class="stats">
        <div class="stat-item">
            <div class="stat-value" id="totalAttempts">0</div>
            <div class="stat-label">Total Attempts</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgAccuracy">0%</div>
            <div class="stat-label">Avg Accuracy</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="bestScore">0%</div>
            <div class="stat-label">Best Score</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="currentStreak">0</div>
            <div class="stat-label">Streak (>85%)</div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>üìà Practice History</h3>
            <button class="close-history" id="closeHistory">Close</button>
        </div>
        <div class="history-list" id="historyList">
            <p style="text-align: center; color: #999; padding: 20px;">No attempts yet.</p>
        </div>
    </div>

    <script>
        // State
        let currentExercise = null;
        let stats = {
            totalAttempts: 0,
            totalAccuracy: 0,
            bestScore: 0,
            currentStreak: 0,
            history: []
        };

        // DOM elements
        const canvas = document.getElementById('referenceCanvas');
        const ctx = canvas.getContext('2d');

        // Load saved stats
        loadStats();

        // Event listeners
        document.getElementById('generateBtn').addEventListener('click', generateExercise);
        document.getElementById('generateBtn2').addEventListener('click', generateExercise);
        document.getElementById('checkBtn').addEventListener('click', checkAccuracy);
        document.getElementById('difficulty').addEventListener('change', (e) => {
            document.getElementById('customRatioInputs').style.display =
                e.target.value === 'custom' ? 'block' : 'none';
        });
        document.getElementById('userWidth').addEventListener('input', enableCheckButton);
        document.getElementById('userHeight').addEventListener('input', enableCheckButton);
        document.getElementById('userWidth').addEventListener('keypress', handleEnterKey);
        document.getElementById('userHeight').addEventListener('keypress', handleEnterKey);
        document.getElementById('statsToggle').addEventListener('click', () => {
            document.querySelector('.stats').classList.toggle('show');
        });
        document.querySelector('.stats').addEventListener('click', () => {
            document.querySelector('.stats').classList.remove('show');
        });
        document.getElementById('closeHistory').addEventListener('click', () => {
            document.getElementById('historyPanel').classList.remove('show');
        });
        document.getElementById('showHintBtn').addEventListener('click', () => {
            document.getElementById('ratioInfo').classList.add('show');
            document.getElementById('showHintBtn').style.display = 'none';
        });

        function enableCheckButton() {
            const width = document.getElementById('userWidth').value;
            const height = document.getElementById('userHeight').value;
            document.getElementById('checkBtn').disabled = !(width && height && currentExercise);
        }

        function handleEnterKey(e) {
            if (e.key === 'Enter' && !document.getElementById('checkBtn').disabled) {
                checkAccuracy();
            }
        }

        function generateExercise() {
            let shapeType = document.getElementById('shapeType').value;
            const difficulty = document.getElementById('difficulty').value;

            // Handle random shape selection
            if (shapeType === 'random') {
                const shapes = ['rectangle', 'ellipse', 'triangle', 'complex', 'complex-rounded'];
                shapeType = shapes[Math.floor(Math.random() * shapes.length)];
            }

            let ratio;

            if (difficulty === 'custom') {
                const customWidth = parseFloat(document.getElementById('customWidth').value);
                const customHeight = parseFloat(document.getElementById('customHeight').value);

                if (!customWidth || !customHeight) {
                    alert('Please enter custom ratio values!');
                    return;
                }

                ratio = { width: customWidth, height: customHeight };
            } else {
                ratio = generateRatio(difficulty);
            }

            currentExercise = { shapeType, difficulty, ratio };

            drawReference();
            updateRatioDisplay();

            // Clear inputs and hide feedback
            document.getElementById('userWidth').value = '';
            document.getElementById('userHeight').value = '';
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('feedbackContent').classList.remove('show');

            // Hide ratio info and show hint button
            document.getElementById('ratioInfo').classList.remove('show');
            document.getElementById('showHintBtn').style.display = 'block';

            // Return focus to first width input
            document.getElementById('userWidth').focus();
        }

        function generateRatio(difficulty) {
            let width, height;

            if (difficulty === 'easy') {
                // Easy: Simple ratios with numbers 1-4
                width = Math.floor(Math.random() * 4) + 1;
                height = Math.floor(Math.random() * 4) + 1;
            } else if (difficulty === 'medium') {
                // Medium: Moderate ratios with numbers 1-10
                width = Math.floor(Math.random() * 10) + 1;
                height = Math.floor(Math.random() * 10) + 1;
            } else if (difficulty === 'hard') {
                // Hard: Complex ratios - can include decimals
                if (Math.random() > 0.5) {
                    // Use whole numbers between 1-20
                    width = Math.floor(Math.random() * 20) + 1;
                    height = Math.floor(Math.random() * 20) + 1;
                } else {
                    // Use decimals for extra challenge
                    width = (Math.random() * 15 + 1).toFixed(1);
                    height = (Math.random() * 15 + 1).toFixed(1);
                }
            }

            // Create description
            const desc = `${width}:${height}`;

            return { width: parseFloat(width), height: parseFloat(height), desc };
        }

        function drawReference() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const { ratio, shapeType } = currentExercise;

            const maxSize = Math.min(canvas.width, canvas.height) * 0.85;
            const scale = maxSize / Math.max(ratio.width, ratio.height);
            const width = ratio.width * scale;
            const height = ratio.height * scale;

            const x = (canvas.width - width) / 2;
            const y = (canvas.height - height) / 2;

            ctx.fillStyle = '#667eea';
            ctx.strokeStyle = '#764ba2';
            ctx.lineWidth = 3;

            if (shapeType === 'rectangle') {
                ctx.fillRect(x, y, width, height);
                ctx.strokeRect(x, y, width, height);
            } else if (shapeType === 'ellipse') {
                ctx.beginPath();
                ctx.ellipse(x + width / 2, y + height / 2, width / 2, height / 2, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            } else if (shapeType === 'triangle') {
                ctx.beginPath();
                ctx.moveTo(x + width / 2, y);
                ctx.lineTo(x + width, y + height);
                ctx.lineTo(x, y + height);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            } else if (shapeType === 'complex' || shapeType === 'complex-rounded') {
                // Generate complex random shape
                const MAX_INTERIOR_POINTS = 7; // Generates 0-n random interior points
                const points = [];

                // For rounded shapes, add multiple perimeter points to ensure curves extend to edges
                // For non-rounded, fewer points for simpler shapes
                const perimeterPointsPerEdge = shapeType === 'complex-rounded' ? 2 : 1;

                for (let i = 0; i < perimeterPointsPerEdge; i++) {
                    points.push({ x: x + Math.random() * width, y: y }); // Top
                    points.push({ x: x + width, y: y + Math.random() * height }); // Right
                    points.push({ x: x + Math.random() * width, y: y + height }); // Bottom
                    points.push({ x: x, y: y + Math.random() * height }); // Left
                }

                // Add 0-N random points inside the rectangle
                const numInteriorPoints = Math.floor(Math.random() * MAX_INTERIOR_POINTS);
                for (let i = 0; i < numInteriorPoints; i++) {
                    points.push({
                        x: x + Math.random() * width,
                        y: y + Math.random() * height
                    });
                }

                // Sort points by angle from center to create a valid polygon
                const centerX = x + width / 2;
                const centerY = y + height / 2;

                points.sort((a, b) => {
                    const angleA = Math.atan2(a.y - centerY, a.x - centerX);
                    const angleB = Math.atan2(b.y - centerY, b.x - centerX);
                    return angleA - angleB;
                });

                // Calculate actual bounding box of the points
                let minX = Math.min(...points.map(p => p.x));
                let maxX = Math.max(...points.map(p => p.x));
                let minY = Math.min(...points.map(p => p.y));
                let maxY = Math.max(...points.map(p => p.y));

                // Scale points to exactly fill the intended bounding box
                const actualWidth = maxX - minX;
                const actualHeight = maxY - minY;
                const actualCenterX = (minX + maxX) / 2;
                const actualCenterY = (minY + maxY) / 2;

                // Scale and translate each point to match intended dimensions
                points.forEach(point => {
                    // Translate to origin
                    let px = point.x - actualCenterX;
                    let py = point.y - actualCenterY;

                    // Scale to match intended dimensions
                    px = px * (width / actualWidth);
                    py = py * (height / actualHeight);

                    // Translate to intended center
                    point.x = px + centerX;
                    point.y = py + centerY;
                });

                // Draw the complex polygon
                if (points.length > 0) {
                    ctx.beginPath();

                    if (shapeType === 'complex-rounded') {
                        // Draw with smooth curves
                        // Start at the midpoint between last and first point
                        const firstMidX = (points[points.length - 1].x + points[0].x) / 2;
                        const firstMidY = (points[points.length - 1].y + points[0].y) / 2;
                        ctx.moveTo(firstMidX, firstMidY);

                        // Draw quadratic curves through each point
                        for (let i = 0; i < points.length; i++) {
                            const current = points[i];
                            const next = points[(i + 1) % points.length];
                            const midX = (current.x + next.x) / 2;
                            const midY = (current.y + next.y) / 2;

                            // Curve to midpoint, using current point as control point
                            ctx.quadraticCurveTo(current.x, current.y, midX, midY);
                        }
                    } else {
                        // Draw with straight lines
                        ctx.moveTo(points[0].x, points[0].y);
                        for (let i = 1; i < points.length; i++) {
                            ctx.lineTo(points[i].x, points[i].y);
                        }
                    }

                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                }
            }
        }

        function updateRatioDisplay() {
            const { ratio } = currentExercise;
            const ratioValue = (ratio.width / ratio.height).toFixed(3);

            document.getElementById('ratioDisplay').textContent =
                `${ratio.width} : ${ratio.height} (${ratioValue})`;

            document.getElementById('ratioDescription').textContent = ratio.desc || '';
        }

        function checkAccuracy() {
            const userWidth = parseFloat(document.getElementById('userWidth').value);
            const userHeight = parseFloat(document.getElementById('userHeight').value);
            const unit = 'mm'; // Always use mm

            if (!userWidth || !userHeight || !currentExercise) return;

            const userRatio = userWidth / userHeight;
            const targetRatio = currentExercise.ratio.width / currentExercise.ratio.height;

            const ratioDifference = Math.abs(userRatio - targetRatio);
            const percentDifference = (ratioDifference / targetRatio) * 100;
            const accuracy = Math.max(0, Math.min(100, 100 - percentDifference));

            displayFeedback(accuracy, userRatio, targetRatio, userWidth, userHeight, unit);
            updateStats(accuracy);
        }

        function displayFeedback(accuracy, userRatio, targetRatio, userWidth, userHeight, unit) {
            const feedbackContent = document.getElementById('feedbackContent');
            const accuracyFill = document.getElementById('accuracyFill');
            const resultTitle = document.getElementById('resultTitle');

            // Show ratio info and hide hint button after checking
            document.getElementById('ratioInfo').classList.add('show');
            document.getElementById('showHintBtn').style.display = 'none';

            feedbackContent.classList.add('show');

            const roundedAccuracy = Math.round(accuracy);
            accuracyFill.style.width = roundedAccuracy + '%';
            accuracyFill.textContent = roundedAccuracy + '%';

            // Color based on score
            if (accuracy >= 90) {
                accuracyFill.style.background = 'linear-gradient(90deg, #4caf50, #8bc34a)';
                resultTitle.textContent = 'üéâ Excellent!';
                resultTitle.style.color = '#2e7d32';
            } else if (accuracy >= 80) {
                accuracyFill.style.background = 'linear-gradient(90deg, #8bc34a, #cddc39)';
                resultTitle.textContent = 'üëè Great job!';
                resultTitle.style.color = '#558b2f';
            } else if (accuracy >= 70) {
                accuracyFill.style.background = 'linear-gradient(90deg, #ffc107, #ffeb3b)';
                resultTitle.textContent = 'üëç Good effort!';
                resultTitle.style.color = '#f57c00';
            } else if (accuracy >= 50) {
                accuracyFill.style.background = 'linear-gradient(90deg, #ff9800, #ffc107)';
                resultTitle.textContent = 'üìö Keep going!';
                resultTitle.style.color = '#e65100';
            } else {
                accuracyFill.style.background = 'linear-gradient(90deg, #f44336, #ff5722)';
                resultTitle.textContent = 'üí™ Keep practicing!';
                resultTitle.style.color = '#c62828';
            }

            // Update feedback cards
            const unitText = ' mm';
            const percentOff = Math.abs(((userRatio - targetRatio) / targetRatio) * 100).toFixed(1);
            const direction = userRatio > targetRatio ? 'wider' : 'taller';

            document.getElementById('yourRatio').textContent = userRatio.toFixed(3);
            document.getElementById('targetRatio').textContent = targetRatio.toFixed(3);
            document.getElementById('yourSize').textContent = `${userWidth}√ó${userHeight}${unitText}`;
            document.getElementById('difference').textContent = `${percentOff}% ${direction}`;

            // Tips
            let tipText = '';
            if (accuracy < 80) {
                if (userRatio > targetRatio * 1.1) {
                    tipText = 'Your drawing is too wide. Try making it narrower or taller.';
                } else if (userRatio < targetRatio * 0.9) {
                    tipText = 'Your drawing is too tall. Try making it shorter or wider.';
                } else {
                    tipText = 'You\'re close! Pay attention to the relative width and height.';
                }
            } else {
                tipText = 'Excellent! Your eye for proportions is developing well!';
            }
            document.getElementById('tipText').textContent = tipText;

            // Focus management based on accuracy
            if (accuracy >= 85) {
                document.getElementById('generateBtn2').focus();
            } else {
                document.getElementById('userWidth').focus();
            }
        }

        function updateStats(score) {
            stats.totalAttempts++;
            stats.totalAccuracy += score;
            stats.bestScore = Math.max(stats.bestScore, score);

            if (score >= 85) {
                stats.currentStreak++;
            } else {
                stats.currentStreak = 0;
            }

            const historyItem = {
                score: Math.round(score),
                shapeType: currentExercise.shapeType,
                difficulty: currentExercise.difficulty,
                ratio: `${currentExercise.ratio.width}:${currentExercise.ratio.height}`,
                timestamp: new Date().toLocaleString()
            };

            stats.history.unshift(historyItem);
            stats.history = stats.history.slice(0, 20);

            updateStatsDisplay();
            updateHistoryDisplay();
            saveStats();
        }

        function updateStatsDisplay() {
            document.getElementById('totalAttempts').textContent = stats.totalAttempts;
            document.getElementById('avgAccuracy').textContent =
                stats.totalAttempts > 0 ? Math.round(stats.totalAccuracy / stats.totalAttempts) + '%' : '0%';
            document.getElementById('bestScore').textContent = Math.round(stats.bestScore) + '%';
            document.getElementById('currentStreak').textContent = stats.currentStreak;
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');

            if (stats.history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No attempts yet.</p>';
                return;
            }

            historyList.innerHTML = stats.history.map(item => `
                <div class="history-item">
                    <div>
                        <strong>${item.shapeType}</strong>
                        <span class="badge">${item.ratio}</span>
                        <span class="badge">${item.difficulty}</span>
                        <div style="font-size: 0.75em; color: #999; margin-top: 3px;">${item.timestamp}</div>
                    </div>
                    <div class="score">${item.score}%</div>
                </div>
            `).join('');
        }

        function saveStats() {
            localStorage.setItem('proportionCheckerStats', JSON.stringify(stats));
        }

        function loadStats() {
            const saved = localStorage.getItem('proportionCheckerStats');
            if (saved) {
                stats = JSON.parse(saved);
                updateStatsDisplay();
                updateHistoryDisplay();
            }
        }
    </script>
</body>

</html>